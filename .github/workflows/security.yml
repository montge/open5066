name: Security Scans

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  cppcheck:
    name: Static Analysis (cppcheck)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --force --inconclusive \
          --suppress=missingIncludeSystem \
          -I src/include -I src/core -I src/serial -I src/protocols \
          src/ 2>&1 | tee cppcheck-report.txt

    - name: Upload cppcheck report
      uses: actions/upload-artifact@v4
      with:
        name: cppcheck-report
        path: cppcheck-report.txt
        retention-days: 30

  clang-tidy:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install clang-tidy
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy

    - name: Run clang-tidy
      run: |
        find src -name '*.c' -exec clang-tidy {} -- \
          -I src/include -I src/core -I src/serial -I src/protocols \
          -DLINUX -D_REENTRANT -DDEBUG \; || true

  buffer-overflow-check:
    name: Buffer Overflow Detection
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Search for unsafe functions
      run: |
        echo "Searching for potentially unsafe string functions..."
        echo "=================================================="

        # Search for dangerous functions
        echo -e "\n=== strcpy usage ==="
        grep -rn "strcpy\s*(" src/ || echo "None found (good!)"

        echo -e "\n=== strcat usage ==="
        grep -rn "strcat\s*(" src/ || echo "None found (good!)"

        echo -e "\n=== sprintf usage ==="
        grep -rn "sprintf\s*(" src/ || echo "None found (good!)"

        echo -e "\n=== gets usage ==="
        grep -rn "gets\s*(" src/ || echo "None found (good!)"

        echo -e "\n=== scanf usage (should check return values) ==="
        grep -rn "scanf\s*(" src/ || echo "None found"

        echo -e "\n=== Summary ==="
        UNSAFE_COUNT=$(grep -r "strcpy\|strcat\|sprintf\|gets" src/ | wc -l)
        echo "Total potentially unsafe function calls: $UNSAFE_COUNT"

        if [ $UNSAFE_COUNT -gt 0 ]; then
          echo "⚠️  WARNING: Unsafe string functions detected!"
          echo "These should be replaced with safer alternatives:"
          echo "  strcpy  -> strncpy or strlcpy"
          echo "  strcat  -> strncat or strlcat"
          echo "  sprintf -> snprintf"
          echo "  gets    -> fgets"
        else
          echo "✓ No unsafe string functions found!"
        fi

  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check system dependencies
      run: |
        echo "Checking for known vulnerable dependencies..."
        echo "This is a C project with minimal dependencies:"
        echo "- pthread (system library)"
        echo "- Standard C library"
        echo ""
        echo "No third-party dependencies detected."
        echo "Future: Consider adding SBOM generation."

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
        queries: security-and-quality

    - name: Build
      run: make

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:cpp"
